
{% extends "base.html" %}

<!---
    Note: Mkdocs returns {{ config.site_url }} with a terminating '/' 
-->

{% block content %}

    <section class="md-grid md-typeset">
        <div class="top-hr">
            <div class="hr">
                <h1 style="text-align: left">Try CA!</h1>
                <p>Here is a sample app integration Sandpack playground to demonstrate <a href="{{config.site_url}}concepts/casdk/">unified balance</a> with Arcana CA SDK.</p>
            </div>
            <div><p style="color: var(--md-an-blue-color); font-size: 0.75rem"><i>If you don't see the Sandpack below, reload the page.</i></p></div>
        </div>
        
        <div style="margin-top: 1rem; margin-bottom: 1rem" id="casandpack"></div>
        
    </section>

{% endblock %}

{% block libs %}
    {{ super() }}
    <!--- Add common javascript libs here if needed for Sandpack
    <script type="module" src="{{ base_url }}/javascripts/common.js"></script>
    --->
{% endblock %}

{% block scripts %}
  <!-- Add scripts that need to run before here -->
  {{ super() }}

  <!--
  Sandpack PoC
  -->
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/": "https://esm.sh/react-dom@18.2.0/",
        "@codesandbox/sandpack-react": "https://esm.sh/@codesandbox/sandpack-react@2.9.0"
      }
    }
  </script>

  <script type="module">
    import React from "react";
    import { createRoot } from "react-dom/client";
    import { Sandpack } from "@codesandbox/sandpack-react";

    const authsandpack = createRoot(document.getElementById("casandpack"));

    let themeType;
    let currentTheme;
    let updateSP;

    // Current Theme check
    const startCurrentTheme = document.body.getAttribute("data-md-color-scheme");

    if (startCurrentTheme === "slate") {
        themeType = "dark";
    }

    //Try Observer method

    // Select the node that will be observed for mutations
    const targetNode = document.body;

    // Options for the observer (which mutations to observe)
    const config = { attributes: true, childList: false, subtree: false };

    // Callback function to execute when mutations are observed
    const callback = (mutationList, observer) => {
        for (const mutation of mutationList) {
            if (mutation.type === "attributes" && mutation.attributeName === "data-md-color-scheme") {
                console.log(`The ${mutation.attributeName} attribute was modified.`);
                console.log("Mutation:", mutation);
                
                const currentTheme = document.body.getAttribute("data-md-color-scheme");
                console.log("Current theme:", currentTheme);
                
                // Determine theme type based on current theme
                if (currentTheme === "slate") {
                    themeType = "dark";
                } else if (currentTheme === "default") {
                    themeType = "light";
                }
                console.log("Theme type:", themeType);
            }
        }
    };

    // Create an observer instance linked to the callback function
    const observer = new MutationObserver(callback);

    // Start observing the target node for configured mutations
    observer.observe(targetNode, config);

    /*
    window.onbeforeunload = function(){
        // Later, you can stop observing
        observer.disconnect();
        return 'The observer is now disconnected!';
    };
    */

    function fetchAndStoreFiles(fileUrls, targetObject) {
        const filePromises = fileUrls.map(url => {
            return fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to fetch ${url}`);
                    }
                    return response.text();
                })
                .then(data => {
                    const fileName = url.substring(url.lastIndexOf('/') + 1);
                    targetObject[`/${fileName}`] = data;
                });
        });

        return Promise.all(filePromises);
    }

    function renderSandpack(template, theme, files, sandpackInstance) {
        const sandpackComponent = React.createElement(
            Sandpack,
            {
                template,
                customSetup: {
                    dependencies: { 
                        "dotenv": "^16.3.1",
                        "parcel": "^2.9.3",
                        "@arcana/ca-sdk": "0.0.1"
                    }
                },
                theme,
                options: {
                    showNavigator: true,
                    showTabs: true,
                    showConsole: true,
                    showConsoleButton: true,
                    externalResources: [
                        "https://www.npmjs.com/package/@arcana/ca-sdk",
                    ],
                    editorHeight: '95vh',
                    autoReload: true,
                    initMode: "immediate", //"user-visible",
                    resizablePanels: true,
                },
                files,
            },
            null
        );
        sandpackInstance.render(sandpackComponent);
    }

    const fileUrls = [
        'https://raw.githubusercontent.com/arcana-network/sandpack-examples/main/ca/index.html',
        'https://raw.githubusercontent.com/arcana-network/sandpack-examples/main/ca/index.js',
        'https://raw.githubusercontent.com/arcana-network/sandpack-examples/main/ca/styles.css',
    ];
    const files = {};
    fetchAndStoreFiles(fileUrls, files)
        .then(() => {
            console.log('Sandpack files:', files);
            renderSandpack('vanilla', themeType, files, authsandpack);
            console.log("Sandpack rendered!")
        })
        .catch(error => {
            console.error('Error loading sample files:', error);
        });
  </script>

  <!-- Chatbase bot script -->
  <script>
    window.chatbaseConfig = {
      chatbotId: "Fbi0FsddfX1zz_DWM5jwJ",
    }
  </script>
  <script
    src="https://www.chatbase.co/embed.min.js"
    id="Fbi0FsddfX1zz_DWM5jwJ"
    defer>
  </script>
{% endblock %}
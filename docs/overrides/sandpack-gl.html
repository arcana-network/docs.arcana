
{% extends "base.html" %}

<!---
    Note: Mkdocs returns {{ config.site_url }} with a terminating '/' 
-->

{% block content %}

<section class="md-grid md-typeset">
        
    <div class="top-hr">
        <div class="hr">
            <h1 style="text-align: left">Try Gasless!</h1>
            <p>Here is a sample app integration Sandpack playground to demonstrate <a href="{{config.site_url}}concepts/gasless-ops/">gasless transactions</a> via MetaMask.</p>
        </div>
        <div><p style="color: var(--md-an-blue-color); font-size: 0.75rem"><i>If you don't see the Sandpack below, reload the page.</i></p></div>
    </div>
    
    <div style="margin-top: 1rem; margin-bottom: 1rem" id="gaslesssandpack"></div>
</section>

{% endblock %}

{% block scripts %}
  <!-- Add scripts that need to run before here -->
  {{ super() }}

  <!--
  Sandpack PoC
  -->

  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/": "https://esm.sh/react-dom@18.2.0/",
        "@codesandbox/sandpack-react": "https://esm.sh/@codesandbox/sandpack-react@2.8.0",
        "@arcana/scw": "https://unpkg.com/@arcana/scw@0.0.43/dist/standalone.mjs"
      }
    }
  </script>

  <script type="module">
    import React from "react";
    import { createRoot } from "react-dom/client";
    import { Sandpack } from "@codesandbox/sandpack-react";

    const gaslesssandpack = createRoot(document.getElementById("gaslesssandpack"));

    let themeType;
    let currentTheme;
    let updateSP;

    // Current Theme check
    const startCurrentTheme = document.body.getAttribute("data-md-color-scheme");

    if (startCurrentTheme === "slate") {
        themeType = "dark";
    }
    //const {sPtheme, setsPTheme} = useState('light'); 
    /*
    const watchMedia = window.matchMedia("(data-md-color-scheme: "slate")");
    let themetype;

    function getTheme(e) {
        if (e.matches)
            themetype = "dark";
        else
            themetype = "default";
    }
    watchMedia.addEventListener("change", getTheme);
    */

    /*
    const prefersDarkMode = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    const themetype = prefersDarkMode ? "dark" : "light";
    */

    //Try Observer method

    // Select the node that will be observed for mutations
    const targetNode = document.body;

    // Options for the observer (which mutations to observe)
    const config = { attributes: true, childList: false, subtree: false };

    // Callback function to execute when mutations are observed
    const callback = (mutationList, observer) => {
    for (const mutation of mutationList) {
        if (mutation.type === "attributes" && mutation.attributeName === "data-md-color-scheme") {
            console.log(`The ${mutation.attributeName} attribute was modified.`);
            console.log("Mutation:", mutation);
            
            const currentTheme = document.body.getAttribute("data-md-color-scheme");
            console.log("Current theme:", currentTheme);
            
            // Determine theme type based on current theme
            if (currentTheme === "slate") {
                themeType = "dark";
            } else if (currentTheme === "default") {
                themeType = "light";
            }
            console.log("Theme type:", themeType);
        }
    }
};

    // Create an observer instance linked to the callback function
    const observer = new MutationObserver(callback);

    // Start observing the target node for configured mutations
    observer.observe(targetNode, config);

    /*
    window.onbeforeunload = function(){
        // Later, you can stop observing
        observer.disconnect();
        return 'The observer is now disconnected!';
    };
    */

    function fetchAndStoreFiles(fileUrls, targetObject) {
        const filePromises = fileUrls.map(url => {
            return fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to fetch ${url}`);
                    }
                    return response.text();
                })
                .then(data => {
                    const fileName = url.substring(url.lastIndexOf('/') + 1);
                    targetObject[`/${fileName}`] = data;
                });
        });

        return Promise.all(filePromises);
    }

    function renderSandpack(template, theme, files, sandpackInstance) {
        const sandpackComponent = React.createElement(
            Sandpack,
            {
                template,
                customSetup: {
                    dependencies: { 
                        "@arcana/scw": "0.0.43",
                    }
                },
                theme,
                options: {
                    showNavigator: true,
                    showTabs: true,
                    showConsole: true,
                    showConsoleButton: true,
                    externalResources: [
                        "https://unpkg.com/@arcana/scw@0.0.43/dist/standalone.mjs"
                    ],
                    editorHeight: '95vh',
                    autoReload: true,
                    initMode: "immediate", //"user-visible",
                    resizablePanels: true,
                },
                files,
            },
            null
        );
        sandpackInstance.render(sandpackComponent);
    }

    const gaslessFileUrls = [
        'https://raw.githubusercontent.com/arcana-network/sandpack-examples/main/gl/index.html',
        'https://raw.githubusercontent.com/arcana-network/sandpack-examples/main/gl/index.js',
        'https://raw.githubusercontent.com/arcana-network/sandpack-examples/main/gl/styles.css',
        'https://raw.githubusercontent.com/arcana-network/sandpack-examples/main/gl/myerc20.js',
    ];

    const glFiles = {};
    fetchAndStoreFiles(gaslessFileUrls, glFiles)
        .then(() => {
            console.log('Gasless Sandpack files:', glFiles);
            renderSandpack('vanilla', themeType, glFiles, gaslesssandpack);
            console.log("GL Sandpack rendered!")
        })
        .catch(error => {
            console.error('Error loading gasless sample files:', error);
        });  
  </script>

  <!-- Chatbase bot script -->
  <script>
    window.chatbaseConfig = {
      chatbotId: "Fbi0FsddfX1zz_DWM5jwJ",
    }
  </script>
  <script
    src="https://www.chatbase.co/embed.min.js"
    id="Fbi0FsddfX1zz_DWM5jwJ"
    defer>
  </script>
{% endblock %}